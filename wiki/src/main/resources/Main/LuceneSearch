<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>Main</web>
<name>LuceneSearch</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1186588178000</creationDate>
<date>1186942604000</date>
<contentUpdateDate>1186942604000</contentUpdateDate>
<version>1.2</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<attachment>
<filename>next.png</filename>
<filesize>395</filesize>
<author>XWiki.Admin</author>
<date>1186927318000</date>
<version>1.1</version>
<comment></comment>
<content>iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAEdSURBVDjLY/j//z8DJZiB6gY0rH7xpW7li3YKDHj1v2bli38lix61k2VA5fJn/9eeeP+/fcOL/wlT7/aRbEDegkf/Vxx/93/xobf/S5c8/u/ecm0eSQYkTX/4f+HBN/8nbX/xf+bul/8Tp9/9r1N0dgnRBgT33QZqfPW/YdXj/42rH//v2vjkv3fHtf9SScceEWWAc8u1/xO2Pv9fsvjB//IlD4CGPPrvXH/5v2Tksc1EGWBaful/+/on/4sW3gfGxsP/9lUX/ksEH1gj6rqdhSgDlPPO/q9b8fB/5bIH/23LL/wXD9i7kqRAlEo6+b908f3/NiXn/4t57V1EcjRKRB75b1145r+o684FZCUkMb8D/0Uct88euMxEKgYA7Ojrv4CgE7EAAAAASUVORK5CYII=</content>
</attachment>
<attachment>
<filename>previous.png</filename>
<filesize>389</filesize>
<author>XWiki.Admin</author>
<date>1186927329000</date>
<version>1.1</version>
<comment></comment>
<content>iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAEXSURBVDjLY/j//z8DJZiBLgZkz37Ynjrz4ReyDEideb89afrDf5ET7v4n2YCEqXf7qpY9/T9r76v/Xu03STMgasLteaVLHv+fufvl/6k7X/y3qrlCvAHBvTeXFC54ANbctv7p/95Nz/5rFZ0nzoCAzpuPsuc++D91x4v/jasf/y9aeP9/89rH/6VTTxJngGPDtc3xU+/879789H/5kgf/02fd+V+17OF/yZhjxBmgVXCaRT3v7BqP1mv/a1Y+/J824/b/woX3/osHHSAtECVjjqy0Lb/wP2/+3f+Zs+/8F3XfS3o0inntXWSeffJ/0tRb/0Ucdv4nKyEJW25ZYBh/5L+w5fb/ZCdlQYMNs4WMt/wfuMyEDwMA0Irn/pDRT58AAAAASUVORK5CYII=</content>
</attachment>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>Main.LuceneSearch</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>## ===================
## Lucene search
## ===================
## Inputs : $request.text
## Outputs : $list, $isScored
## ===================

1 Search

#set($query = $request.getParameter("text"))
#if(!$query)
	#set($query = "")
#end
#set($itemsPerPage = "30")

{pre}
&lt;form action="$doc.name" method="post"&gt;
&lt;div&gt;
&lt;input type="text" name="text" value="$query" /&gt;
&lt;input type="submit" value="Search"/&gt;
&lt;/div&gt;
&lt;/form&gt;
{/pre}

#if($query != "")
	#set($lucene = $xwiki.getPlugin("lucene"))
	#if($lucene)
                ## ---------------
                ## Lucene search
                ## ---------------              
		#set($wikinames = "xwiki")
		#set($languages = "default,en,de")
		#set($firstIndex = $request.getParameter("firstIndex"))
		#if(!$firstIndex)
			#set($firstIndex = "1")
		#end
		#set($searchresults = $lucene.getSearchResults($query, $wikinames, $languages, $xwiki))
		#set($results = $searchresults.getResults($firstIndex,$itemsPerPage))
		#if($searchresults.getHitcount()&gt;0)
                        ## -----------------
                        ## Results numbers
                        ## -----------------
			#set($lastIndex=$searchresults.getEndIndex($firstIndex, $itemsPerPage))
			#if($searchresults.getHitcount()==1)
				One result:
			#else
				Results $firstIndex - $lastIndex of ${searchresults.getHitcount()}:
			#end
                        ## ---------------
                        ## Previous page
                        ## ---------------
			#if($searchresults.hasPrevious($firstIndex))
				#set($linkfirstIndex = $searchresults.getPreviousIndex($firstIndex,$itemsPerPage))
				#set($link = "${doc.name}?text=${query}&amp;firstIndex=${linkfirstIndex}")
                                {pre}
				&lt;a href="$link"&gt;&lt;img src="${doc.getAttachmentURL("previous.png")}" alt="previous" /&gt;previous page&lt;/a&gt;
				{/pre}
			#end		
                        ## -------------
                        ## Next page
                        ## -------------
			#if($searchresults.hasNext($firstIndex,$itemsPerPage))
				#set($linkfirstIndex = $searchresults.getNextIndex($firstIndex,$itemsPerPage))
				#set($link = "${doc.name}?text=${query}&amp;firstIndex=${linkfirstIndex}")
                                {pre}
				&lt;a href="$link"&gt;&lt;img src="${doc.getAttachmentURL("next.png")}" alt="next" /&gt;next page&lt;/a&gt;
                                {/pre}
			#end

                        ## -----------------
                        ## Display results
                        ## -----------------
                        #set ($list = $results)
                        #set ($isScored = true)
                        #includeInContext("XWiki.Results")
                #end
	#else
		Error: Lucene plugin not found.
	#end
#end

#set($lucene = $xwiki.getPlugin("lucene"))
#if($lucene)
#set($doRebuild = $request.getParameter("rebuild"))
#if($doRebuild)
  #if($doRebuild=="yes")
		#set($documentCount = $lucene.rebuildIndex($xwiki,$context))
		#if(${documentCount}&gt;=0)
			#info("Started index rebuild with $documentCount documents.\\
                               Will take some time depending on the number of pages/attachments.")
		#else
			#error("Error: Index rebuild failed.")
		#end
  #end
#else
	#if($xwiki.hasAdminRights())
		#info ("[Rebuild the lucene index&gt;${doc.web}.${doc.name}?rebuild=yes]")
	#end
#end
#end

#info("This is the new lucene search engine.\\
          You can still use the XWiki [default search engine&gt;WebSearch?text=$query]..")</content>
</xwikidoc>
